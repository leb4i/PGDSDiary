@{
    ViewData["Title"] = "Съобщения";
    var currentUser = ViewBag.CurrentUser;
}

<div class="page-header">
    <div>
        <h1>Съобщения</h1>
        <p>Вашите разговори</p>
    </div>
    <button class="btn btn-primary" onclick="document.getElementById('newChatModal').style.display='flex'">
        <i class="fas fa-plus"></i> Нов разговор
    </button>
</div>

<div style="display:grid;grid-template-columns:300px 1fr;gap:20px;height:calc(100vh - 180px);">

    <!-- SIDEBAR -->
    <div style="background:white;border-radius:12px;border:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;">
        <div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;">
            <i class="fas fa-search" style="color:var(--text-muted);"></i>
            <input type="text" id="contactSearch" placeholder="Търси разговор..."
                   oninput="filterContacts(this.value)"
                   style="border:none;outline:none;font-size:14px;width:100%;font-family:inherit;background:transparent;" />
        </div>
        <div style="overflow-y:auto;flex:1;" id="contactList">
            @if (!((IEnumerable<dynamic>)ViewBag.Contacts).Any())
            {
                <div style="text-align:center;padding:32px;color:var(--text-muted);">
                    <i class="fas fa-comment-slash" style="font-size:32px;margin-bottom:8px;display:block;"></i>
                    Няма разговори
                </div>
            }
            @foreach (var c in ViewBag.Contacts)
            {
                <a onclick="openChat('@c.UserId', '@c.UserName')" data-name="@c.UserName"
                   style="display:flex;align-items:center;gap:12px;padding:12px 16px;text-decoration:none;color:var(--text);border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s;@(c.Unread > 0 ? "background:#eef3fd;" : "")"
                   onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='@(c.Unread > 0 ? "#eef3fd" : "")'">
                    <div style="width:42px;height:42px;border-radius:50%;background:var(--accent);color:white;font-weight:800;font-size:16px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                        @c.UserName.Substring(0, 1).ToUpper()
                    </div>
                    <div style="flex:1;overflow:hidden;">
                        <div style="font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">@c.UserName</div>
                        <div style="font-size:12px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">@c.LastMessage</div>
                    </div>
                    @if (c.Unread > 0)
                    {
                        <span style="background:var(--accent);color:white;border-radius:50%;width:20px;height:20px;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;">@c.Unread</span>
                    }
                </a>
            }
        </div>
    </div>

    <!-- MAIN CHAT AREA -->
    <div id="chatArea" style="background:white;border-radius:12px;border:1px solid var(--border);display:flex;flex-direction:column;">

        <!-- EMPTY STATE -->
        <div id="emptyState" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">
            <i class="fas fa-comments" style="font-size:64px;color:#cbd5e1;margin-bottom:16px;"></i>
            <p style="font-size:16px;font-weight:600;color:var(--text-muted);">Избери разговор</p>
            <p style="color:var(--text-muted);font-size:13px;">или започни нов с бутона горе</p>
        </div>

        <!-- CHAT STATE (скрит по подразбиране) -->
        <div id="chatState" style="display:none;flex-direction:column;height:100%;">
            <!-- Header -->
            <div id="chatHeader" style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;">
                <div id="chatAvatar" style="width:40px;height:40px;border-radius:50%;background:var(--accent);color:white;font-weight:800;font-size:16px;display:flex;align-items:center;justify-content:center;"></div>
                <div>
                    <div id="chatName" style="font-weight:700;font-size:15px;"></div>
                </div>
            </div>
            <!-- Messages -->
            <div id="chatMessages" style="flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px;"></div>
            <!-- Input -->
            <div style="padding:16px;border-top:1px solid var(--border);display:flex;gap:10px;">
                <input type="text" id="messageInput" class="form-control" placeholder="Напиши съобщение..."
                       onkeydown="if(event.key==='Enter') sendMessage()" />
                <button class="btn btn-primary" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

    </div>
</div>

<!-- НОВ РАЗГОВОР -->
<div id="newChatModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:9999;align-items:center;justify-content:center;">
    <div style="background:white;border-radius:12px;width:420px;max-height:80vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.2);">
        <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;">
            <i class="fas fa-plus" style="color:var(--accent);"></i>
            <span style="font-weight:700;font-size:15px;">Нов разговор</span>
            <button onclick="document.getElementById('newChatModal').style.display='none'"
                    style="margin-left:auto;background:none;border:none;cursor:pointer;font-size:20px;color:var(--text-muted);line-height:1;">
                ✕
            </button>
        </div>
        <div style="padding:12px 16px;border-bottom:1px solid var(--border);">
            <input type="text" id="userSearch" class="form-control" placeholder="Търси потребител..."
                   oninput="filterUsers(this.value)"
                   style="width:100%;box-sizing:border-box;" />
        </div>
        <div id="userList" style="overflow-y:auto;flex:1;">
            @foreach (var u in ViewBag.AllUsers)
            {
                <a onclick="openChat('@u.Id', '@u.FirstName @u.LastName'); document.getElementById('newChatModal').style.display='none';"
                   style="display:flex;align-items:center;gap:12px;padding:12px 16px;text-decoration:none;color:var(--text);border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s;"
                   onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background=''">
                    <div style="width:38px;height:38px;border-radius:50%;background:var(--accent);color:white;font-weight:800;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                        @u.FirstName?.Substring(0, 1).ToUpper()
                    </div>
                    <div>
                        <div style="font-weight:700;font-size:14px;" class="user-name">@u.FirstName @u.LastName</div>
                        <div style="font-size:12px;color:var(--text-muted);">@u.UserName</div>
                    </div>
                </a>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        const currentUserId = "@currentUser.Id";
        let activeUserId = null;

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .withAutomaticReconnect()
            .build();

        connection.on("ReceiveMessage", (msg) => {
            if (msg.senderId === activeUserId || msg.senderId === currentUserId) {
                appendMessage(msg.senderId, msg.text, msg.sentAt);
            }
        });

        connection.start().catch(err => console.error(err));

        async function openChat(userId, userName) {
            activeUserId = userId;

            document.getElementById('emptyState').style.display = 'none';
            const chatState = document.getElementById('chatState');
            chatState.style.display = 'flex';

            document.getElementById('chatAvatar').textContent = userName.charAt(0).toUpperCase();
            document.getElementById('chatName').textContent = userName;

            // Зареди съобщенията
            const res = await fetch(`/Messages/GetMessages?userId=${userId}`);
            const messages = await res.json();

            const container = document.getElementById('chatMessages');
            container.innerHTML = '';
            messages.forEach(m => appendMessage(m.senderId, m.text, m.sentAt));
            scrollToBottom();
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text || !activeUserId) return;
            connection.invoke("SendMessage", activeUserId, text).catch(err => console.error(err));
            input.value = '';
        }

        function appendMessage(senderId, text, time) {
            const isMe = senderId === currentUserId;
            const div = document.createElement('div');
            div.style.cssText = `display:flex;justify-content:${isMe ? 'flex-end' : 'flex-start'};`;
            div.innerHTML = `
                <div style="max-width:65%;padding:10px 14px;border-radius:16px;${isMe ? 'background:var(--accent);color:white;border-bottom-right-radius:4px;' : 'background:var(--bg);color:var(--text);border-bottom-left-radius:4px;'}">
                    <div style="font-size:14px;line-height:1.5;">${text}</div>
                    <div style="font-size:11px;opacity:0.7;margin-top:4px;text-align:right;">${time}</div>
                </div>`;
            document.getElementById('chatMessages').appendChild(div);
            scrollToBottom();
        }

        function scrollToBottom() {
            const el = document.getElementById('chatMessages');
            el.scrollTop = el.scrollHeight;
        }

        function filterContacts(q) {
            document.querySelectorAll('#contactList a').forEach(el => {
                const name = (el.dataset.name || '').toLowerCase();
                el.style.display = name.includes(q.toLowerCase()) ? '' : 'none';
            });
        }

        function filterUsers(q) {
            document.querySelectorAll('#userList a').forEach(el => {
                const name = el.querySelector('.user-name')?.textContent.toLowerCase() ?? '';
                el.style.display = (q === '' || name.includes(q.toLowerCase())) ? 'flex' : 'none';
            });
        }

    </script>
}