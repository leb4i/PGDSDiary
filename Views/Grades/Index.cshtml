@model IEnumerable<GradingSystem.Models.Grade>

@{
    ViewData["Title"] = "Оценки";
}

<div class="page-header">
    <div>
        <h1>Оценки</h1>
        <p>
            @if (User.IsInRole("Student"))
            {
                <text>Твоите оценки</text>
            }
            else if (User.IsInRole("Teacher"))
            {

                <text>Оценки по твоите предмети</text>
            }
            else
            {

                <text>Всички оценки в системата</text>
            }
        </p>
    </div>
    @if (User.IsInRole("Admin") || User.IsInRole("Teacher"))
    {
        <a asp-action="Create" class="btn btn-primary">
            <i class="fas fa-plus"></i> Добави оценка
        </a>
    }
</div>

@* ФИЛТЪР ЗА УЧИТЕЛ *@
@if (User.IsInRole("Teacher") && ViewBag.MyClasses != null)
{
    <div class="card" style="margin-bottom:20px;">
        <div class="card-title">
            <i class="fas fa-filter" style="color:var(--accent);"></i>
            Филтър по клас
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <a href="/Grades"
               class="btn @(ViewBag.SelectedClassId == null ? "btn-primary" : "btn-outline") btn-sm">
                Всички класове
            </a>
            @foreach (var cls in ViewBag.MyClasses)
            {
                <a href="/Grades?classId=@cls.Id"
                   class="btn @(ViewBag.SelectedClassId == cls.Id ? "btn-primary" : "btn-outline") btn-sm">
                    @cls.Name
                </a>
            }
        </div>
    </div>
}

@if (User.IsInRole("Student"))
{
    @* ГРУПИРАНИ ПО ПРЕДМЕТ *@
    var grouped = Model.GroupBy(g => g.Subject?.Name).OrderBy(g => g.Key);
    int rowNum = 1;
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th style="width:40px;">№</th>
                    <th>Предмет</th>
                    <th>Текущи оценки</th>
                    <th>Среден успех</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var group in grouped)
                {
                    var avg = group.Average(g => (double)g.Value);
                    string avgClass = avg >= 5.5 ? "grade-6" :
                                      avg >= 4.5 ? "grade-5" :
                                      avg >= 3.5 ? "grade-4" :
                                      avg >= 3.0 ? "grade-3" : "grade-2";
                    <tr>
                        <td style="color:var(--text-muted);font-weight:700;">@rowNum</td>
                        <td style="font-weight:700;">
                            <i class="fas fa-book-open" style="color:var(--text-muted);margin-right:8px;font-size:12px;"></i>
                            @group.Key
                        </td>
                        <td>
                            <div style="display:flex;gap:5px;flex-wrap:wrap;">
                                @foreach (var g in group.OrderBy(g => g.GradedAt))
                                {
                                    string bc = g.Value >= 6 ? "grade-6" :
                                    g.Value >= 5 ? "grade-5" :
                                    g.Value >= 4 ? "grade-4" :
                                    g.Value >= 3 ? "grade-3" : "grade-2";
                                    <span class="grade-badge @bc grade-clickable"
                                          onclick="showGradePopup(this)"
                                          data-value="@g.Value.ToString("F2")"
                                          data-type="@g.Type"
                                          data-date="@g.GradedAt.ToString("dd.MM.yyyy")"
                                          data-subject="@group.Key">
                                        @g.Value.ToString("F0")
                                    </span>
                                }
                            </div>
                        </td>
                        <td>
                            <span class="grade-badge @avgClass">@avg.ToString("F2")</span>
                        </td>
                    </tr>
                    rowNum++;
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Ученик</th>
                    @if (!User.IsInRole("Student"))
                    {
                        <th>Клас</th>
                    }
                    <th>Предмет</th>
                    <th>Оценка</th>
                    <th>Вид</th>
                    <th>Дата</th>
                    @if (User.IsInRole("Admin") || User.IsInRole("Teacher"))
                    {
                        <th></th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var g in Model)
                {
                    <tr>
                        <td style="font-weight:600;">@g.Student?.FirstName @g.Student?.LastName</td>
                        <td><span class="badge badge-green">@g.Student?.Class?.Name</span></td>
                        <td style="color:var(--text-muted);">@g.Subject?.Name</td>
                        <td>
                            @{
                                string bc = g.Value >= 6 ? "grade-6" :
                                            g.Value >= 5 ? "grade-5" :
                                            g.Value >= 4 ? "grade-4" :
                                            g.Value >= 3 ? "grade-3" : "grade-2";
                            }
                            <span class="grade-badge @bc">@g.Value.ToString("F2")</span>
                        </td>
                        <td><span class="badge badge-gray">@g.Type</span></td>
                        <td style="color:var(--text-muted);font-size:12px;">@g.GradedAt.ToString("dd.MM.yyyy")</td>
                        @if (User.IsInRole("Admin") || User.IsInRole("Teacher"))
                        {
                            <td>
                                <a asp-action="Edit" asp-route-id="@g.Id" class="btn btn-outline btn-sm">
                                    <i class="fas fa-pen"></i>
                                </a>
                                <a asp-action="Delete" asp-route-id="@g.Id" class="btn btn-danger btn-sm">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
<!-- POPUP -->
<div id="gradePopup" class="grade-popup" style="display:none;">
    <button onclick="hideGradePopup()" class="grade-popup-close">
        <i class="fas fa-xmark"></i>
    </button>
    <div class="grade-popup-header">
        <span id="popupValue"></span>
        <span id="popupDate"></span>
    </div>
    <div class="grade-popup-row"><i class="fas fa-tag"></i> <span id="popupType"></span></div>
    <div class="grade-popup-row"><i class="fas fa-book"></i> <span id="popupSubject"></span></div>
    <div class="grade-popup-row"><i class="fas fa-user"></i> <span id="popupBy"></span></div>
</div

@section Scripts {
    <script>
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') hideGradePopup();
        });

        function showGradePopup(el) {
            const popup = document.getElementById('gradePopup');
            const overlay = document.getElementById('gradeOverlay');
            document.getElementById('popupValue').textContent = 'Оценка: ' + el.dataset.value;
            document.getElementById('popupDate').textContent = el.dataset.date;
            document.getElementById('popupType').textContent = el.dataset.type;
            document.getElementById('popupSubject').textContent = el.dataset.subject;
            document.getElementById('popupBy').textContent = 'Въведена от: ' + el.dataset.by;

            const rect = el.getBoundingClientRect();
            const popupW = 220;
            let left = rect.right + window.scrollX + 10;
            let top  = rect.top  + window.scrollY - 10;

            if (left + popupW > window.innerWidth - 20)
                left = rect.left + window.scrollX - popupW - 10;

            popup.style.top  = top + 'px';
            popup.style.left = left + 'px';
            popup.style.display = 'block';
            overlay.style.display = 'block';
        }

        function hideGradePopup() {
            document.getElementById('gradePopup').style.display = 'none';
            document.getElementById('gradeOverlay').style.display = 'none';
        }
    </script>
}