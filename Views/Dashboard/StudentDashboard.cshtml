@{
    ViewData["Title"] = "Начало";
}

@if (ViewBag.Error != null)
{
    <div style="color:red;">@ViewBag.Error</div>
}
else
{
    var student = ViewBag.Student;

    <div class="page-header">
        <div>
            <h1>Здравей, @student.FirstName!</h1>
            <p>Клас @student.Class?.Name</p>
        </div>
    </div>

    <!-- STAT КАРТИ -->
    <div class="stat-grid">

        <a href="/Grades" class="stat-card-new" style="text-decoration:none;">
            <div class="stat-card-icon" style="background:#eef3fd;color:#2e6be6;">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-card-body">
                <div class="stat-card-value">@ViewBag.MyAverage</div>
                <div class="stat-card-label">Среден успех</div>
                <div class="stat-card-sub">твоят успех</div>
            </div>
        </a>

        <a class="stat-card-new" style="text-decoration:none;">
            <div class="stat-card-icon" style="background:#e8f5ee;color:#2e7d50;">
                <i class="fas fa-ranking-star"></i>
            </div>
            <div class="stat-card-body">
                <div class="stat-card-value">@ViewBag.ClassPosition / @ViewBag.ClassTotal</div>
                <div class="stat-card-label">Позиция в клас</div>
                <div class="stat-card-sub">клас @student.Class?.Name</div>
            </div>
        </a>

        <a href="/Attendances" class="stat-card-new" style="text-decoration:none;">
            <div class="stat-card-icon" style="background:#fee2e2;color:#e53e3e;">
                <i class="fas fa-calendar-xmark"></i>
            </div>
            <div class="stat-card-body">
                <div class="stat-card-value">@ViewBag.TotalAbsences</div>
                <div class="stat-card-label">Отсъствия</div>
                <div class="stat-card-sub">неизвинени</div>
            </div>
        </a>

    </div>

    <!-- ГРАФИКА + ТОП 10 -->
    <!-- ГРАФИКА + ТОП 10 -->
    <div class="dashboard-grid" style="margin-bottom:20px;">

        <div class="card">
            <div class="card-title">
                <i class="fas fa-chart-line" style="color:var(--accent);"></i>
                Динамика на успеха
            </div>
            <div class="chart-wrapper">
                <canvas id="gradeChart"></canvas>
            </div>
            <div class="card-title" style="margin-top:20px;border-top:1px solid var(--border);padding-top:16px;">
                <i class="fas fa-calendar-xmark" style="color:#e53e3e;"></i>
                Отсъствия по предмет
            </div>
            <div class="chart-wrapper">
                <canvas id="absenceChart"></canvas>
            </div>
        </div>

        



        <div class="card">
            <div class="card-title">
                <i class="fas fa-ranking-star" style="color:#d97706;"></i>
                Топ 10 в училище
            </div>
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ученик</th>
                        <th>Клас</th>
                        <th>Успех</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int rank = 1;
                    }
                    @foreach (var s in ViewBag.Top10)
                    {
                        bool isMe = s.StudentId == student.Id;
                        <tr style="@(isMe ? "background:#e8f5ee;font-weight:800;" : "")">
                            <td style="font-weight:700;color:var(--text-muted);">@rank</td>
                            <td style="font-weight:@(isMe ? "800" : "600");">
                                @s.FirstName @s.LastName @(isMe ? "⭐" : "")
                            </td>
                            <td><span class="badge badge-blue">@s.ClassName</span></td>
                            <td>
                                @{
                                    string bc = s.Average >= 5.5 ? "grade-6" :
                                    s.Average >= 4.5 ? "grade-5" :
                                    s.Average >= 3.5 ? "grade-4" : "grade-3";
                                }
                                <span class="grade-badge @bc">@s.Average.ToString("F2")</span>
                            </td>
                        </tr>
                        rank++;
                    }
                </tbody>
            </table>
        </div>
    </div>

}
@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script>
        const labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize((List<string>)ViewBag.GradeLabels));
        const values = @Html.Raw(System.Text.Json.JsonSerializer.Serialize((List<double>)ViewBag.GradeValues));

        new Chart(document.getElementById('gradeChart'), {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Среден успех',
                    data: values,
                    borderColor: '#2e7d50',
                    backgroundColor: 'rgba(46,125,80,0.06)',
                    borderWidth: 2.5,
                    pointBackgroundColor: '#2e7d50',
                    pointRadius: 4,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        min: 2, max: 6,
                        ticks: { stepSize: 1 },
                        grid: { color: '#f1f5f9' }
                    },
                    x: { grid: { display: false } }
                }
            }
        });

        const absData2 = @Html.Raw((string)ViewBag.AbsencesBySubject);

        if (absData2.length > 0) {
            new Chart(document.getElementById('absenceChart'), {
                type: 'bar',
                data: {
                    labels: absData2.map(a => a.name ?? a.Name),
                    datasets: [{
                        data: absData2.map(a => a.count ?? a.Count),
                        backgroundColor: '#e53e3e',
                        borderRadius: 6,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        } else {
            document.getElementById('absenceChart').outerHTML =
                '<div style="text-align:center;padding:32px;color:var(--text-muted);"><i class="fas fa-check-circle" style="font-size:32px;color:#16a34a;margin-bottom:8px;display:block;"></i>Нямаш отсъствия!</div>';
        }
    </script>
}