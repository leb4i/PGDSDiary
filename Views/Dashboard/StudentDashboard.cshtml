@{
    ViewData["Title"] = "Начало — Ученик";
}

@if (ViewBag.Error != null)
{
    <div style="color:red;">@ViewBag.Error</div>
}
else
{
    var student = ViewBag.Student;

    <div class="page-header">
        <div>
            <h1>Здравей, @student.FirstName!</h1>
            <p>Клас @student.Class?.Name</p>
        </div>
    </div>

    <!-- Stat карти -->
    <div class="stat-grid" style="grid-template-columns: repeat(3, 1fr); max-width: 700px;">
        <div class="stat-card" style="background:#1b3a2d;">
            <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
            <div class="stat-value">@ViewBag.MyAverage</div>
            <div class="stat-label">Среден успех</div>
        </div>
        <div class="stat-card" style="background:#2e7d50;">
            <div class="stat-icon"><i class="fas fa-ranking-star"></i></div>
            <div class="stat-value">@ViewBag.ClassPosition / @ViewBag.ClassTotal</div>
            <div class="stat-label">Позиция в клас</div>
        </div>
        <div class="stat-card" style="background:#dc3545;">
            <div class="stat-icon"><i class="fas fa-calendar-xmark"></i></div>
            <div class="stat-value">@ViewBag.TotalAbsences</div>
            <div class="stat-label">Отсъствия</div>
        </div>
    </div>

    <div class="dashboard-grid">

        <!-- Line Graph -->
        <div class="card">
            <div class="card-title">
                <i class="fas fa-chart-line" style="color:var(--accent);"></i>
                Динамика на успеха
            </div>
            <div class="chart-wrapper">
                <canvas id="gradeChart"></canvas>
            </div>
        </div>

        <!-- Топ 10 -->
        <div class="card">
            <div class="card-title">
                <i class="fas fa-ranking-star" style="color:#e8a020;"></i>
                Топ 10 в училище
            </div>
            <table>
                <thead>
                    <tr><th>#</th><th>Ученик</th><th>Клас</th><th>Успех</th></tr>
                </thead>
                <tbody>
                    @{
                        int rank = 1;
                    }
                    @foreach (var s in ViewBag.Top10)
                    {
                        bool isMe = s.StudentId == student.Id;
                        <tr style="@(isMe ? "background:#e8f5ee;font-weight:800;" : "")">
                            <td style="font-weight:700;">@rank</td>
                            <td>@s.FirstName @s.LastName @(isMe ? "⭐" : "")</td>
                            <td><span class="badge badge-green">@s.ClassName</span></td>
                            <td>
                                @{
                                    string bc = s.Average >= 5.5 ? "grade-6" : s.Average >= 4.5 ? "grade-5" : s.Average >= 3.5 ? "grade-4" : "grade-3";
                                }
                                <span class="grade-badge @bc">@s.Average.ToString("F2")</span>
                            </td>
                        </tr>
                        rank++;
                    }
                </tbody>
            </table>
        </div>

        <!-- Моите оценки -->
        <div class="card" style="grid-column: 1 / -1;">
            <div class="card-title">
                <i class="fas fa-star" style="color:var(--accent);"></i>
                Моите оценки
            </div>
            <table>
                <thead>
                    <tr><th>Предмет</th><th>Оценка</th><th>Вид</th><th>Дата</th></tr>
                </thead>
                <tbody>
                    @foreach (var g in ViewBag.MyGrades)
                    {
                        <tr>
                            <td style="font-weight:600;">@g.Subject?.Name</td>
                            <td>
                                @{
                                    string bc = g.Value >= 6 ? "grade-6" : g.Value >= 5 ? "grade-5" : g.Value >= 4 ? "grade-4" : g.Value >= 3 ? "grade-3" : "grade-2";
                                }
                                <span class="grade-badge @bc">@g.Value.ToString("F2")</span>
                            </td>
                            <td><span class="badge badge-blue">@g.Type</span></td>
                            <td style="color:var(--text-muted);font-size:13px;">@g.GradedAt.ToString("dd.MM.yyyy")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

    </div>
}

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script>
        const labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize((List<string>)ViewBag.GradeLabels));
        const values = @Html.Raw(System.Text.Json.JsonSerializer.Serialize((List<double>)ViewBag.GradeValues));

        new Chart(document.getElementById('gradeChart'), {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Среден успех',
                    data: values,
                    borderColor: '#2e7d50',
                    backgroundColor: 'rgba(46,125,80,0.08)',
                    borderWidth: 2.5,
                    pointBackgroundColor: '#2e7d50',
                    pointRadius: 5,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { min: 2, max: 6, ticks: { stepSize: 1 }, grid: { color: '#f1f5f9' } },
                    x: { grid: { display: false } }
                }
            }
        });
    </script>
}