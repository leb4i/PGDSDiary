@{
    ViewData["Title"] = "Начало";
}

<!-- STAT КАРТИ -->
<div class="stat-grid">

    <div class="stat-card-new">
        <div class="stat-card-icon" style="background:#eef3fd;color:#2e6be6;">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-card-body">
            <div class="stat-card-value">@ViewBag.AverageGrade</div>
            <div class="stat-card-label">Среден успех</div>
            <div class="stat-card-sub">за цялото училище</div>
        </div>
    </div>

    <div class="stat-card-new">
        <div class="stat-card-icon" style="background:#e8f5ee;color:#2e7d50;">
            <i class="fas fa-user-graduate"></i>
        </div>
        <div class="stat-card-body">
            <div class="stat-card-value">@ViewBag.TotalStudents</div>
            <div class="stat-card-label">Ученици</div>
            <div class="stat-card-sub">активни в системата</div>
        </div>
    </div>

    <div class="stat-card-new">
        <div class="stat-card-icon" style="background:#fef9c3;color:#a16207;">
            <i class="fas fa-star"></i>
        </div>
        <div class="stat-card-body">
            <div class="stat-card-value">@ViewBag.TotalGrades</div>
            <div class="stat-card-label">Оценки</div>
            <div class="stat-card-sub">въведени тази година</div>
        </div>
    </div>

    <div class="stat-card-new">
        <div class="stat-card-icon" style="background:#fee2e2;color:#e53e3e;">
            <i class="fas fa-calendar-xmark"></i>
        </div>
        <div class="stat-card-body">
            <div class="stat-card-value">@ViewBag.TotalAbsences</div>
            <div class="stat-card-label">Отсъствия</div>
            <div class="stat-card-sub">неизвинени</div>
        </div>
    </div>

    <div class="stat-card-new">
        <div class="stat-card-icon" style="background:#fff7ed;color:#c2410c;">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-card-body">
            <div class="stat-card-value">@ViewBag.TotalLate</div>
            <div class="stat-card-label">Закъснения</div>
            <div class="stat-card-sub">записани общо</div>
        </div>
    </div>
</div>

<!-- СРЕДНА СЕКЦИЯ — графика + последни оценки -->
<div class="dashboard-grid" style="margin-bottom:20px;">

    <div class="card">
        <div class="card-title">
            <i class="fas fa-chart-bar" style="color:var(--accent);"></i>
            Успех по предмет
        </div>
        <div class="chart-wrapper">
            <canvas id="subjectsChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-title">
            <i class="fas fa-clock" style="color:var(--accent);"></i>
            Последно въведени оценки
        </div>
        <table>
            <thead>
                <tr>
                    <th>Ученик</th>
                    <th>Предмет</th>
                    <th>Оценка</th>
                    <th>Дата</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var g in ViewBag.RecentGrades)
                {
                    <tr>
                        <td style="font-weight:600;">
                            @g.Student?.FirstName @g.Student?.LastName
                        </td>
                        <td style="color:var(--text-muted);">@g.Subject?.Name</td>
                        <td>
                            @{
                                string bc = g.Value >= 6 ? "grade-6" :
                                g.Value >= 5 ? "grade-5" :
                                g.Value >= 4 ? "grade-4" :
                                g.Value >= 3 ? "grade-3" : "grade-2";
                            }
                            <span class="grade-badge @bc">@g.Value.ToString("F2")</span>
                        </td>
                        <td style="color:var(--text-muted);font-size:12px;">
                            @g.GradedAt.ToString("dd.MM.yyyy")
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

</div>

<!-- ТОП 10 -->
<div class="card">
    <div class="card-title">
        <i class="fas fa-ranking-star" style="color:#d97706;"></i>
        Топ 10 ученика в училище
    </div>

    <div class="top10-grid">
        @{
            int rank = 1;
            foreach (var s in ViewBag.Top10)
            {
                string medalClass = rank == 1 ? "medal-gold" :
                rank == 2 ? "medal-silver" :
                rank == 3 ? "medal-bronze" : "medal-default";
                <div class="top10-card">
                    <div class="top10-rank @medalClass">@rank</div>
                    <div class="top10-info">
                        <div class="top10-name">@s.FirstName @s.LastName</div>
                        <div class="top10-class">@s.ClassName</div>
                    </div>
                    <div class="top10-avg">
                        @{
                            string avgClass = s.Average >= 5.5 ? "grade-6" :
                            s.Average >= 4.5 ? "grade-5" :
                            s.Average >= 3.5 ? "grade-4" : "grade-3";
                        }
                        <span class="grade-badge @avgClass">@s.Average.ToString("F2")</span>
                    </div>
                </div>
                rank++;
            }
        }
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script>
        const labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                    ((IEnumerable<dynamic>)ViewBag.TopSubjects).Select(x => (string)x.ShortName ?? (string)x.Subject).ToList()));
    const values = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                ((IEnumerable<dynamic>)ViewBag.TopSubjects).Select(x => (double)x.Average).ToList()));

    new Chart(document.getElementById('subjectsChart'), {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                data: values,
                backgroundColor: ['#2e6be6','#2e7d50','#d97706','#e53e3e','#7c3aed'],
                borderRadius: 7,
                borderSkipped: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { min: 2, max: 6, ticks: { stepSize: 1 }, grid: { color: '#f1f5f9' } },
                x: { grid: { display: false } }
            }
        }
    });
</script>
}